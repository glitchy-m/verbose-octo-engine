<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>tab audio visualizer â€” share tab only</title>
<style>
  :root{--bg:#0b0f14;--panel:#0f1720;--muted:#9aa7b2;--accent:#34d399;--glass:rgba(255,255,255,0.035)}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#dfe7ea;background:linear-gradient(180deg,#02050a 0%, #07101a 100%);}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:20px;height:100vh;padding:22px;box-sizing:border-box}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 6px 24px rgba(2,6,12,0.6);}
  header h1{margin:0;font-size:18px}
  header p{margin:6px 0 12px;color:var(--muted);font-size:13px}
  .controls{display:flex;flex-direction:column;gap:10px}
  button{appearance:none;border:0;padding:10px 12px;border-radius:10px;background:var(--accent);color:#062018;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
  select,input[type=range]{width:100%}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .muted{font-size:12px;color:var(--muted)}
  .canvas-wrap{position:relative;border-radius:12px;overflow:hidden}
  canvas{width:100%;height:100%;display:block}
  .footer{font-size:12px;color:var(--muted);margin-top:12px}
  .visualizer-list{display:flex;flex-wrap:wrap;gap:8px}
  .vis-btn{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
  .vis-btn.active{background:linear-gradient(90deg, rgba(52,211,153,0.14), rgba(16,185,129,0.06));border-color:rgba(52,211,153,0.22);color:#dffbf0}
  .small{font-size:12px}
  .note{background:var(--glass);padding:10px;border-radius:8px;margin-top:12px;color:var(--muted);font-size:13px}
  .top-row{display:flex;gap:8px}
  .flex{display:flex;gap:8px}
  .range-value{font-weight:700;color:#fff;padding-left:8px}
</style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <header>
      <h1>tab audio visualizer</h1>
      <p>only allows sharing a single tab with audio. click "share tab audio" and make sure you check "share audio" when selecting a tab.</p>
    </header>

    <div class="controls">
      <div class="top-row">
        <button id="shareBtn">share tab audio</button>
        <button id="stopBtn" class="ghost">stop</button>
      </div>

      <div style="margin-top:8px">
        <label class="small">visualizer</label>
        <div class="visualizer-list" id="visList"></div>
      </div>

      <div style="margin-top:10px">
        <label>fft size <span class="range-value" id="fftVal">2048</span></label>
        <input id="fftRange" type="range" min="256" max="8192" step="256" value="2048">
      </div>

      <div>
        <label>smoothing <span class="range-value" id="smoothVal">0.8</span></label>
        <input id="smoothRange" type="range" min="0" max="0.99" step="0.01" value="0.8">
      </div>

      <div>
        <label>bars / density <span class="range-value" id="densityVal">128</span></label>
        <input id="densityRange" type="range" min="8" max="512" step="1" value="128">
      </div>

      <div class="note">
        <strong>instructions:</strong>
        <ol style="padding-left:18px;margin:8px 0 0;color:var(--muted)">
          <li>click "share tab audio".</li>
          <li>choose a single tab in the picker and check "share audio".</li>
          <li>play audio in that tab, the visualizer will respond.</li>
        </ol>
      </div>

      <div class="footer small">visualizers: bars, radial, waveform, particles, spectrogram, oscilloscope</div>
    </div>
  </aside>

  <main class="panel canvas-wrap" id="mainPanel">
    <canvas id="visCanvas"></canvas>
  </main>
</div>

<script>
const shareBtn = document.getElementById('shareBtn');
const stopBtn = document.getElementById('stopBtn');
const visList = document.getElementById('visList');
const fftRange = document.getElementById('fftRange');
const smoothRange = document.getElementById('smoothRange');
const densityRange = document.getElementById('densityRange');
const fftVal = document.getElementById('fftVal');
const smoothVal = document.getElementById('smoothVal');
const densityVal = document.getElementById('densityVal');

const canvas = document.getElementById('visCanvas');
const ctx = canvas.getContext('2d');
let W=0,H=0;
function resize(){ canvas.width = Math.floor(canvas.clientWidth * devicePixelRatio); canvas.height = Math.floor(canvas.clientHeight * devicePixelRatio); W = canvas.width; H = canvas.height; }
window.addEventListener('resize', resize);
resize();

let audioCtx=null, analyser=null, sourceNode=null, dataArray=null, timeArray=null, animationId=null, displayStream=null;
let currentVis='bars';
const visualizers=['bars','radial','waveform','particles','spectrogram','oscilloscope'];
visualizers.forEach(v=>{ const b=document.createElement('button'); b.className='vis-btn'+(v===currentVis?' active':''); b.textContent=v; b.onclick=()=>{ currentVis=v; document.querySelectorAll('.vis-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }; visList.appendChild(b); });
fftRange.addEventListener('input',()=>{ fftVal.textContent=fftRange.value; if(analyser) analyser.fftSize=Number(fftRange.value); });
smoothRange.addEventListener('input',()=>{ smoothVal.textContent=Number(smoothRange.value).toFixed(2); if(analyser) analyser.smoothingTimeConstant=Number(smoothRange.value); });
densityRange.addEventListener('input',()=>{ densityVal.textContent=densityRange.value; });

async function startShare(){
  if(audioCtx && audioCtx.state!=='closed') stopShare();
  try{
    // force only a single tab selection
    const stream=await navigator.mediaDevices.getDisplayMedia({video:false,audio:{mandatory:{chromeMediaSource:'tab'}}});
    if(!stream.getAudioTracks().length){ alert('no audio track, make sure you checked "share audio" when selecting a tab.'); stream.getTracks().forEach(t=>t.stop()); return; }
    displayStream=stream;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)(); await audioCtx.resume();
    analyser=audioCtx.createAnalyser(); analyser.fftSize=Number(fftRange.value); analyser.smoothingTimeConstant=Number(smoothRange.value);
    sourceNode=audioCtx.createMediaStreamSource(stream); sourceNode.connect(analyser);
    const bufferLen=analyser.frequencyBinCount; dataArray=new Uint8Array(bufferLen); timeArray=new Uint8Array(bufferLen);
    stream.getVideoTracks().forEach(t=>t.onended=stopShare);
    stream.getAudioTracks().forEach(t=>t.onended=stopShare);
    tick();
  }catch(err){ alert('tab share failed: '+(err.message||err)); }
}
function stopShare(){ if(displayStream){ displayStream.getTracks().forEach(t=>t.stop()); displayStream=null; } if(sourceNode){ try{sourceNode.disconnect();}catch(e){} sourceNode=null; } if(analyser){ analyser.disconnect(); analyser=null; } if(audioCtx){ try{audioCtx.close();}catch(e){} audioCtx=null; } if(animationId) cancelAnimationFrame(animationId); animationId=null; clearCanvas(); }
stopBtn.onclick=stopShare; shareBtn.onclick=startShare;
function clearCanvas(){ ctx.clearRect(0,0,W,H); }
function tick(){ if(!analyser) return; analyser.getByteFrequencyData(dataArray); analyser.getByteTimeDomainData(timeArray); ctx.clearRect(0,0,W,H); if(currentVis==='bars') drawBars(); else if(currentVis==='radial') drawRadial(); else if(currentVis==='waveform') drawWaveform(); else if(currentVis==='particles') drawParticles(); else if(currentVis==='spectrogram') drawSpectrogram(); else if(currentVis==='oscilloscope') drawOscilloscope(); animationId=requestAnimationFrame(tick); }
function drawBars(){ const bins=Math.min(dataArray.length, Number(densityRange.value)); const barW=W/bins; for(let i=0;i<bins;i++){ const v=dataArray[Math.floor(i*dataArray.length/bins)]/255; const h=v*H; const x=i*barW; ctx.fillStyle=`hsl(${Math.floor(map(i,0,bins,160,360))} 80% 60%)`; ctx.fillRect(x,H-h,Math.max(1,barW-2),h); }}
function drawRadial(){ const cx=W/2,cy=H/2,radius=Math.min(W,H)*0.18; const bins=Math.min(dataArray.length,Number(densityRange.value)); const maxR=Math.min(W,H)*0.45; for(let i=0;i<bins;i++){ const a=map(i,0,bins,0,Math.PI*2); const v=dataArray[Math.floor(i*dataArray.length/bins)]/255; const r=radius+v*(maxR-radius); const x=cx+Math.cos(a)*r; const y=cy+Math.sin(a)*r; const x0=cx+Math.cos(a)*radius; const y0=cy+Math.sin(a)*radius; ctx.lineWidth=2*devicePixelRatio; ctx.strokeStyle=`hsl(${Math.floor(map(i,0,bins,0,360))} 80% 65%)`; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x,y); ctx.stroke(); }}
function drawWaveform(){ ctx.lineWidth=2*devicePixelRatio; ctx.beginPath(); const step=Math.max(1,Math.floor(timeArray.length/W)); const mid=H/2; ctx.moveTo(0,mid); for(let x=0,i=0;x<W;x++,i+=step){ const v=(timeArray[i]-128)/128; ctx.lineTo(x,mid+v*(H*0.45)); } ctx.strokeStyle='rgba(60,180,220,0.95)'; ctx.stroke(); }
function drawParticles(){ const bass=dataArray.slice(0,Math.floor(dataArray.length*0.12)).reduce((s,v)=>s+v,0)/(dataArray.length*0.12)/255; for(let p of particles){ p.vx+=(Math.random()-0.5)*0.02+(Math.random()-0.5)*bass*0.5; p.vy+=(Math.random()-0.5)*0.02-bass*0.15; p.x+=p.vx*(W*0.002); p.y+=p.vy*(H*0.002); if(p.x<-0.05)p.x=1.05;if(p.x>1.05)p.x=-0.05;if(p.y<-0.05)p.y=1.05;if(p.y>1.05)p.y=-0.05; const size=p.size+bass*8; ctx.beginPath(); ctx.arc(p.x*W,p.y*H,size*devicePixelRatio,0,Math.PI*2); ctx.fillStyle=`rgba(${Math.floor(200+55*bass)},${Math.floor(80+160*bass)},220,0.6)`; ctx.fill(); }}
function drawSpectrogram(){ if(!specImg){ specImg=document.createElement('canvas'); specImg.width=W; specImg.height=H; } const sctx=specImg.getContext('2d'); const shift=Math.max(1,Math.floor(devicePixelRatio)); const img=sctx.getImageData(shift,0,specImg.width-shift,specImg.height); sctx.putImageData(img,0,0); const col=sctx.createImageData(1,specImg.height); const bins=specImg.height; for(let y=0;y<bins;y++){ const idx=Math.floor(map(y,0,bins,0,dataArray.length-1)); const v=dataArray[idx]; const hue=Math.floor(map(v,0,255,240,0)); const rgb=hslToRgb(hue/360,1,0.5); const i=(bins-y-1)*4; col.data[i]=rgb[0]; col.data[i+1]=rgb[1]; col.data[i+2]=rgb[2]; col.data[i+3]=255; } sctx.putImageData(col,specImg.width-shift,0); ctx.drawImage(specImg,0,0,W,H); }
function drawOscilloscope(){ ctx.fillStyle='#021017'; ctx.fillRect(0,0,W,H); ctx.lineWidth=2*devicePixelRatio; ctx.strokeStyle='#0fef9c'; ctx.beginPath(); const step=Math.max(1,Math.floor(timeArray.length/W)); const mid=H/2; for(let x=0,i=0;x<W;x++,i+=step){ const v=(timeArray[i]-128)/128; const y=mid+v*(H*0.45); if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke(); }
function lerp(a,b,t){return a+(b-a)*t;} function map(v,a,b,c,d){return c+(d-c)*((v-a)/(b-a));}
function hslToRgb(h,s,l){let r,g,b;if(s==0){r=g=b=l;}else{const hue2rgb=function(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}; const q=l<0.5?l*(1+s):l+s-l*s; const p=2*l-q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);} return [Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
const particles=[]; for(let i=0;i<300;i++){particles.push({x:Math.random(),y:Math.random(),vx:0,vy:0,size:Math.random()*3+1,life:0});}
let specImg=null;
(function idleLoop(){if(!animationId){ctx.clearRect(0,0,W,H);}requestAnimationFrame(idleLoop);})();
</script>
</body>
</html>
